<!DOCTYPE html>

<html>

<head>
    <title>è›™çš„ç§äººåŠ©ç†</title>
    <meta charset="utf-8">

    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/2.1.3/marked.min.js"></script> 
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/codemirror.min.css" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/codemirror.min.js"></script> -->

    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="è›™çš„ç§äººåŠ©ç†">
    <meta name="viewport" content=" maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="{{ url_for('getimg', path='app.ico') }}">
    <link rel="icon" href="{{ url_for('getimg', path='app.ico') }}">

    <link rel="stylesheet" href="{{ url_for('getcss', path='vs2015.min.css') }}">
    <script src="{{ url_for('getjs', path='highlight.min.js') }}"></script>
    <script src="{{ url_for('getjs', path='marked.min.js') }}"></script>
    <script src="{{ url_for('getjs', path='codemirror.min.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('getcss', path='codemirror.min.css') }}">

    <script>hljs.highlightAll();</script>

</head>

<body>
    <div id="divmain" class="chat-container">
        <style>
            body::before {
                content: " ";
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: transparent;
                z-index: -1;
                /* æ§åˆ¶é€æ˜åº¦ */
                background-image: url("{{ url_for('getimg', path='bkpic.jpg') }}");
                background-size: cover;
                opacity: 0.5;
                /* æ§åˆ¶é€æ˜åº¦ */
            }

            .chat-container * {
                font-weight: bold;
                -webkit-user-select: text;
                /* Safari */
                -moz-user-select: text;
                /* Firefox */
                -ms-user-select: text;
                /* Internet Explorer/Edge */
                user-select: text;
            }

            chat-container {
                background-color: #f1f1f1;
                border: 1px solid #ccc;
                border-radius: 5px;
                /* margin: 20px auto; */
                /* max-width: 600px; */
                padding: 20px;
                position: relative;

                width: 80%;
                margin: 20px auto;
                max-height: 50%;
            }

            .chat-header {
                background-color: rgba(51, 51, 51, 0.9);
                border-radius: 5px 5px 0 0;
                color: #fff;
                display: flex;
                justify-content: space-between;
                padding: 10px;
            }

            .hljs {
                background-color: rgba(0, 0, 0, 0.8);
            }

            .chat-header h1 {
                font-size: 1.5rem;
                margin: 0;
            }

            .chat-header button {
                background-color: transparent;
                border: none;
                color: #fff;
                cursor: pointer;
                font-size: 1.2rem;
            }

            .chat-messages {
                list-style: none;
                margin: 0;
                padding: 0;
            }

            .chat-messages li {
                border-radius: 5px;
                margin-bottom: 10px;
                padding: 10px;
                white-space: pre-wrap;

            }

            .chat-message pre {
                white-space: pre-wrap;
                word-wrap: break-word;
                margin: 0;
                font-size: 14px;
                font-family: 'Courier New', Courier, monospace;
                position: relative;
            }

            .chat-message pre .copy-button {
                position: absolute;
                top: 5px;
                right: 5px;
                font-size: 14px;
                padding: 5px;
                background-color: #fff;
                color: rgb(51, 51, 51, 0.8);
                border: 1px solid #ccc;
                border-radius: 3px;
                cursor: pointer;
                transition: all 0.3s ease-in-out;
            }

            .chat-message pre .copy-button:hover {
                background-color: #333;
                color: #fff;
            }

            .chat-messages li.user-message {
                background-color: #fff;
                border: 1px solid #ccc;
                float: left;
                max-width: 60%;
            }

            .chat-messages li.chatgpt-message {
                background-color: #0084ff;
                color: #fff;
                float: right;
                max-width: 60%;
            }

            .chat-input {
                border: none;
                border-radius: 5px;
                font-size: 1rem;
                margin-top: 10px;
                padding: 10px;
                width: 98%;
            }

            /* ç§»åŠ¨ç«¯æ ·å¼*/
            @media only screen and (max-width: 1000px) {
                body::before {
                    background-image: url("{{ url_for('getimg', path='bkpic_mobile.jpg') }}");
                }

                .chat-container * {
                    font-size: 120%;
                }

                .indexmain {
                    padding-top: 10% !important;
                }

                .chat-input {
                    font-size: 2.5rem;
                    width: 98%;
                }

                .chat-header {
                    background-color: rgba(51, 51, 51, 0.9);
                }

                .hljs {
                    font-family: "Courier New", Courier, monospace;
                    font-size: 50px !important;
                    color: #333;
                    background-color: rgba(241, 241, 241, 0.8);
                }

                .chat-messages li {
                    font-size: 2.5rem;
                }

                .chath1 {
                    font-size: 30px;
                }

                .copy-button {
                    font-size: 35px !important;
                    /* è®¾ç½®å­—ä½“å¤§å° */
                    padding: 8px 16px;
                    /* è®¾ç½®å†…è¾¹è· */
                    border-radius: 4px;
                    /* è®¾ç½®è¾¹æ¡†åœ†è§’ */
                }
            }
        </style>
        <div class="chat-header">
            <h1 cid="chath1" class='chath1'>ç§äººåŠ©ç†è›™</h1>
            <button class="clear-button" style="margin-left: auto;" onclick="clearChatHistory()">æ¸…é™¤å†å²è®°å½•</button>
        </div>
        <!-- <div>
        OpenAI ä½™é¢: {{ balance }}
    </div> -->
        <form id="chat-form" onsubmit="handleFormSubmit(event)">
            <input type="text" class="chat-input" placeholder="è¯´å‡ºä½ çš„æ¢¦æƒ³[]~(ï¿£â–½ï¿£)~*">
            <!-- <textarea id="myTextarea" class="chat-input"></textarea> -->q
        </form>

        <ul class="chat-messages"></ul>


        <script>
            window.addEventListener('load', () => {
                const messages = JSON.parse(localStorage.getItem('chatMessages')) || [];
                messages.forEach(({ author, message }) => {
                    addMessage(author, message, true);
                });
            });

            maxmsgcount = "{{maxmsgcount}}"
        </script>

        <script>
            // function addMessage(author, message) {
            //     const chatMessages = document.querySelector('.chat-messages');
            //     const messageElement = document.createElement('li');
            //     messageElement.classList.add('chat-message');
            //     const authorElement = document.createElement('div');
            //     authorElement.classList.add('message-author');
            //     authorElement.innerText = author;
            //     const codeElement = document.createElement('code');
            //     codeElement.classList.add('hljs');
            //     codeElement.innerHTML = marked(message);
            //     const preElement = document.createElement('pre');
            //     preElement.appendChild(codeElement);
            //     const textElement = document.createElement('div');
            //     textElement.classList.add('message-text');
            //     textElement.appendChild(preElement);
            //     messageElement.appendChild(authorElement);
            //     messageElement.appendChild(textElement);
            //     chatMessages.prepend(messageElement); // å°†æ–°æ¶ˆæ¯æ’å…¥åˆ°èŠå¤©æ¡†çš„é¡¶éƒ¨
            //     hljs.highlightBlock(codeElement);
            //     preElement.scrollTop = preElement.scrollHeight; // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            //     const copyButton = document.createElement('div');
            //     copyButton.classList.add('copy-button');
            //     copyButton.innerText = 'å¤åˆ¶';
            //     copyButton.addEventListener('click', () => {
            //         const codeText = codeElement.innerText;
            //         navigator.clipboard.writeText(codeText).then(() => {
            //             alert('ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            //         }).catch((error) => {
            //             console.error('å¤åˆ¶å¤±è´¥ï¼š', error);
            //         });
            //     });
            //     preElement.appendChild(copyButton);
            // }



            // // æ·»åŠ ä¸€ä¸ªå‡½æ•°å°†èŠå¤©æ¶ˆæ¯ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ä¸­ï¼š
            // function saveChatMessages(messages) {
            //     localStorage.setItem('chatMessages', JSON.stringify(messages));
            // }
            // æ·»åŠ ä¸€ä¸ªå‡½æ•°å°†èŠå¤©æ¶ˆæ¯ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ä¸­ï¼š
            function saveChatMessages(messages) {
                const maxMessages = maxmsgcount; // æœ€å¤§ä¿å­˜æ¶ˆæ¯æ•°
                const savedMessages = messages.slice(-maxMessages); // åªä¿å­˜æœ€è¿‘çš„1000æ¡è®°å½•
                localStorage.setItem('chatMessages', JSON.stringify(savedMessages));
            }


            //  æ·»åŠ èŠå¤©æ¶ˆæ¯åˆ°èŠå¤©æ¡†ä¸­
            function addMessage(author, message, isinitmsg) {
                const chatMessages = document.querySelector('.chat-messages'); // è·å–èŠå¤©æ¡†çš„ DOM å…ƒç´ 
                const messageElement = document.createElement('li'); // åˆ›å»ºä¸€ä¸ª li å…ƒç´ ä½œä¸ºæ–°æ¶ˆæ¯çš„å®¹å™¨
                messageElement.classList.add('chat-message'); // æ·»åŠ ç±»åä»¥ä¾¿æ ·å¼æ§åˆ¶

                // åˆ›å»ºä¸€ä¸ª div å…ƒç´ ç”¨äºæ˜¾ç¤ºæ¶ˆæ¯çš„ä½œè€…
                const authorElement = document.createElement('div');
                authorElement.classList.add('message-author');
                authorElement.innerText = author;

                // åˆ›å»ºä¸€ä¸ª code å…ƒç´ ç”¨äºæ˜¾ç¤ºæ¶ˆæ¯çš„å†…å®¹
                const codeElement = document.createElement('code');
                codeElement.classList.add('hljs');
                codeElement.innerHTML = marked(message); // ä½¿ç”¨ marked åº“å°†æ¶ˆæ¯å†…å®¹è½¬æ¢æˆ HTML

                // åˆ›å»ºä¸€ä¸ª pre å…ƒç´ ä½œä¸º code å…ƒç´ çš„å®¹å™¨ï¼Œå¹¶å°† code å…ƒç´ æ·»åŠ åˆ°å…¶ä¸­
                const preElement = document.createElement('pre');
                preElement.appendChild(codeElement);

                // åˆ›å»ºä¸€ä¸ª div å…ƒç´ ç”¨äºæ˜¾ç¤ºæ¶ˆæ¯çš„æ–‡æœ¬ï¼Œå¹¶å°† pre å…ƒç´ æ·»åŠ åˆ°å…¶ä¸­
                const textElement = document.createElement('div');
                textElement.classList.add('message-text');
                textElement.appendChild(preElement);

                // å°†ä½œè€…å’Œæ–‡æœ¬å…ƒç´ æ·»åŠ åˆ°æ–°æ¶ˆæ¯çš„å®¹å™¨ä¸­
                messageElement.appendChild(authorElement);
                messageElement.appendChild(textElement);

                chatMessages.prepend(messageElement); // å°†æ–°æ¶ˆæ¯æ’å…¥åˆ°èŠå¤©æ¡†çš„é¡¶éƒ¨

                hljs.highlightBlock(codeElement); // ä½¿ç”¨ highlight.js åº“é«˜äº®ä»£ç 

                preElement.scrollTop = preElement.scrollHeight; // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨

                // åˆ›å»ºä¸€ä¸ª div å…ƒç´ ä½œä¸ºå¤åˆ¶æŒ‰é’®ï¼Œå¹¶æ·»åŠ ç‚¹å‡»äº‹ä»¶å¤„ç†å‡½æ•°
                const copyButton = document.createElement('div');
                copyButton.classList.add('copy-button');
                copyButton.innerText = 'å¤åˆ¶';

                copyButton.addEventListener('click', () => {
                    // å°†ä»£ç æ–‡æœ¬å¤åˆ¶åˆ°å‰ªè´´æ¿
                    const codeText = codeElement.innerText;
                    const tempInput = document.createElement('input');
                    tempInput.value = codeText;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempInput);

                    // åœ¨èŠå¤©æ¡†ä¸­æ˜¾ç¤ºå¤åˆ¶æˆåŠŸçš„æç¤ºï¼Œå¹¶åœ¨ 2 ç§’åè‡ªåŠ¨æ¶ˆå¤±
                    const copySuccess = document.createElement('div');
                    copySuccess.classList.add('copy-success');
                    copySuccess.innerText = 'å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼';
                    chatMessages.prepend(copySuccess);
                    setTimeout(() => {
                        copySuccess.remove();
                    }, 2000);
                });
                preElement.appendChild(copyButton); // å°†å¤åˆ¶æŒ‰é’®æ·»åŠ åˆ° pre å…ƒç´ ä¸­
                chatMessages.prepend(messageElement); // å†æ¬¡å°†æ–°æ¶ˆæ¯æ’å…¥åˆ°èŠå¤©æ¡†çš„é¡¶éƒ¨ï¼Œä»¥ä¾¿å¤åˆ¶æŒ‰é’®æ˜¾ç¤ºåœ¨å‰é¢

                if (!isinitmsg) {
                    // å°†èŠå¤©æ¶ˆæ¯ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ä¸­
                    const messages = JSON.parse(localStorage.getItem('chatMessages')) || [];
                    messages.push({ author, message });
                    saveChatMessages(messages);
                }

            }

            // æ¶ˆæ¯æ¥å—å¤„ç†
            // function handleFormSubmit(e) {
            //     const chatInput = document.querySelector('.chat-input');
            //     e.preventDefault();
            //     const message = chatInput.value;
            //     if (message.trim() !== '') {
            //         addMessage('æˆ‘:', message, false);
            //         chatInput.value = '';
            //         chatInput.focus();
            //         fetch(`/chat/get?msg=${encodeURIComponent(message)}`)
            //             .then(response => response.text())
            //             .then(data => {
            //                 addMessage('ğŸ¸(*â•¹â–½â•¹*):', data, false);
            //                 chatInput.focus();
            //                 // Call your refresh method here
            //                 // refresh();
            //             })
            //             .catch(error => {
            //                 console.error(error);
            //                 addMessage('ğŸ¸:', 'ä¸´è¡¨æ¶•é›¶ï¼Œä¸çŸ¥æ‰€äº‘(*â•¹â–½â•¹*).', false);
            //             });
            //     }
            // }

            // æ¶ˆæ¯æ¥å—å¤„ç†
            function handleFormSubmit(e) {
                const chatInput = document.querySelector('.chat-input');
                const chatTitle = document.querySelector('.chath1');
                e.preventDefault();
                const message = chatInput.value;
                if (message.trim() !== '') {
                    chatTitle.innerText = 'ç§äººåŠ©ç†è›™(æ‰“å­—ä¸­...)'; // å°†æ ‡é¢˜æ”¹ä¸º "ç§äººåŠ©ç†è›™(æ‰“å­—ä¸­...)"
                    addMessage('æˆ‘:', message, false);
                    chatInput.value = '';
                    chatInput.focus();
                    fetch(`/chat/get?msg=${encodeURIComponent(message)}`)
                        .then(response => response.text())
                        .then(data => {
                            addMessage('ğŸ¸(*â•¹â–½â•¹*):', data, false);
                            chatInput.focus();
                            chatTitle.innerText = 'ç§äººåŠ©ç†è›™'; // å°†æ ‡é¢˜æ”¹å›åŸæ¥çš„æ–‡æœ¬å†…å®¹
                            // Call your refresh method here
                            // refresh();
                        })
                        .catch(error => {
                            console.error(error);
                            addMessage('ğŸ¸:', 'ä¸´è¡¨æ¶•é›¶ï¼Œä¸çŸ¥æ‰€äº‘(*â•¹â–½â•¹*).', false);
                            chatTitle.innerText = 'ç§äººåŠ©ç†è›™'; // å°†æ ‡é¢˜æ”¹å›åŸæ¥çš„æ–‡æœ¬å†…å®¹
                        });
                }
            }



            // æ¸…é™¤èŠå¤©å†å²è®°å½•
            function clearChatHistory() {
                localStorage.removeItem('chatMessages');
                location.reload();
            }
        </script>

    </div>
</body>